<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="week SQL challenge.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="528"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="members" custom_title="0" dock_id="1" table="4,7:mainmembers"/><dock_state state="000000ff00000000fd00000001000000020000000000000000fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000ffffffff0000011300ffffff000000000000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings/></tab_browse><tab_sql><sql name="SQL 1*">CREATE TABLE IF NOT EXISTS sales (
  customer_id VARCHAR(1),
  order_date DATE,
  product_id INTEGER
);

CREATE TABLE IF NOT EXISTS menu (
  product_id INTEGER,
  product_name VARCHAR(5),
  price INTEGER
);

CREATE TABLE IF NOT EXISTS members (
  customer_id VARCHAR(1),
  join_date DATE
);
INSERT INTO sales (customer_id, order_date, product_id)
VALUES
  ('A', '2021-01-01', 1),
  ('A', '2021-01-01', 2),
  ('A', '2021-01-07', 2),
  ('A', '2021-01-10', 3),
  ('A', '2021-01-11', 3),
  ('A', '2021-01-11', 3),
  ('B', '2021-01-01', 2),
  ('B', '2021-01-02', 2),
  ('B', '2021-01-04', 1),
  ('B', '2021-01-11', 1),
  ('B', '2021-01-16', 3),
  ('B', '2021-02-01', 3),
  ('C', '2021-01-01', 3),
  ('C', '2021-01-01', 3),
  ('C', '2021-01-07', 3);


INSERT INTO menu (product_id, product_name, price)
VALUES
  (1, 'sushi', 10),
  (2, 'curry', 15),
  (3, 'ramen', 12);

INSERT INTO members (customer_id, join_date)
VALUES
  ('A', '2021-01-07'),
  ('B', '2021-01-09');
  --What is the total amount each customer spent at the restaurant?
SELECT 
    S.customer_id,
    SUM(M.price) AS Total_spend
FROM sales AS S
INNER JOIN menu AS M
ON S.product_id = M.product_id
GROUP BY S.customer_id;

 --How many days has each customer visited the restaurant?
SELECT
    customer_id,
    COUNT(DISTINCT order_date) AS days
FROM sales
GROUP BY customer_id;

--What was the first item from the menu purchased by each customer?
WITH CTE AS (
    SELECT 
        S.customer_id,
        S.product_id,
        M.product_name,
        RANK() OVER(PARTITION BY S.customer_id ORDER BY S.order_date ASC) AS rnk
    FROM sales AS S
    INNER JOIN menu AS M
        ON S.product_id = M.product_id
)
SELECT
    customer_id,
    product_id,
    product_name
FROM CTE
WHERE rnk = 1;


--What is the most purchased item on the menu and how many times was it purchased by all customers?
SELECT
    menu.product_name,
    COUNT(sales.order_date) AS Orders
FROM sales
INNER JOIN menu
    ON sales.product_id = menu.product_id
GROUP BY menu.product_name
ORDER BY Orders DESC
LIMIT 1;


--Which item was the most popular for each customer?
WITH CustomerRank AS (
    SELECT
        sales.customer_id,
        menu.product_name,
        COUNT(*) AS Orders,
        RANK() OVER(PARTITION BY sales.customer_id ORDER BY COUNT(*) DESC) AS rnk
    FROM sales
    INNER JOIN menu
        ON sales.product_id = menu.product_id
    GROUP BY sales.customer_id, menu.product_name
)
SELECT
    customer_id,
    product_name,
    Orders
FROM CustomerRank
WHERE rnk = 1;


--Which item was purchased first by the customer after they became a member?
WITH CTE AS (
    SELECT 
        sales.customer_id,
        sales.product_id,
        menu.product_name,
        sales.order_date,
        RANK() OVER(PARTITION BY sales.customer_id ORDER BY sales.order_date ASC) AS rnk
    FROM sales
    INNER JOIN menu
        ON sales.product_id = menu.product_id
    INNER JOIN members
        ON sales.customer_id = members.customer_id
    WHERE sales.order_date &gt;= members.join_date
)
SELECT
    customer_id,
    product_name,
    order_date
FROM CTE
WHERE rnk = 1;

--Which item was purchased just before the customer became a member?

WITH CTE AS (
    SELECT 
        sales.customer_id,
        sales.product_id,
        menu.product_name,
        sales.order_date,
        RANK() OVER(PARTITION BY sales.customer_id ORDER BY sales.order_date DESC) AS rnk
    FROM sales
    INNER JOIN menu
        ON sales.product_id = menu.product_id
    INNER JOIN members
        ON sales.customer_id = members.customer_id
    WHERE sales.order_date &lt; members.join_date
)
SELECT
    customer_id,
    product_name,
    order_date
FROM CTE
WHERE rnk = 1;


--What is the total items and amount spent for each member before they became a member?
SELECT
    sales.customer_id,
    COUNT(sales.product_id) AS total_items,
    SUM(menu.price) AS total_spent
FROM sales
INNER JOIN menu
    ON sales.product_id = menu.product_id
INNER JOIN members
    ON sales.customer_id = members.customer_id
WHERE sales.order_date &lt; members.join_date
GROUP BY sales.customer_id;


--If each $1 spent equates to 10 points and sushi has a 2x points multiplier - how many points would each customer have?

SELECT
    sales.customer_id,
    SUM(
        CASE 
            WHEN menu.product_name = 'sushi' THEN menu.price * 10 * 2
            ELSE menu.price * 10
        END
    ) AS points
FROM sales
INNER JOIN menu
    ON sales.product_id = menu.product_id
GROUP BY sales.customer_id;


--In the first week after a customer joins the program (including their join date) they earn 2x points on all items, not just sushi - how many points do customer A and B have at the end of January?
SELECT
    sales.customer_id,
    SUM(
        CASE 
            WHEN sales.order_date BETWEEN members.join_date 
                 AND DATE(members.join_date, '+6 day')
            THEN menu.price * 10 * 2
            ELSE 
                CASE 
                    WHEN menu.product_name = 'sushi' THEN menu.price * 10 * 2
                    ELSE menu.price * 10
                END
        END
    ) AS points
FROM sales
INNER JOIN menu
    ON sales.product_id = menu.product_id
INNER JOIN members
    ON sales.customer_id = members.customer_id
WHERE sales.customer_id IN ('A','B')
  AND sales.order_date &lt;= '2021-01-31'
GROUP BY sales.customer_id;






</sql><current_tab id="0"/></tab_sql></sqlb_project>
